name: Update Parent Version (Directly)

on:
  push:
  schedule:
    # 每天 UTC 时间 08:00 执行一次，可自定义
    - cron: '0 8 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  update-parent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取完整历史，以便能 push

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install xmlstarlet
        run: sudo apt-get update && sudo apt-get install -y xmlstarlet

      - name: Fetch latest version of the parent from Maven Central
        id: fetch-latest-version
        run: |
          GROUP_ID=io.github.tmgg
          ARTIFACT_ID=tmgg-system-parent

          # Maven Central 查询 API
          GROUP_PATH=$(echo $GROUP_ID | tr '.' '/')
          API_URL="https://search.maven.org/solrsearch/select?q=g:${GROUP_ID}+AND+a:${ARTIFACT_ID}&core=gav&rows=1&wt=json"
          echo "构建查询地址 ${API_URL}"
          echo "正在查询 ${GROUP_ID}:${ARTIFACT_ID} 的最新版本..."
          RESPONSE=$(curl -s "${API_URL}")

          # 提取 latestVersion 字段
          LATEST_VERSION=$(echo "$RESPONSE" | jq -r '.response.docs[0].latestVersion')

          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            echo "❌ 无法从 Maven Central 获取最新版本，请检查 groupId 和 artifactId 是否正确。"
            echo "你设置的 groupId=${GROUP_ID}, artifactId=${ARTIFACT_ID}"
            exit 1
          fi

          echo "✅ 最新版本是: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Update parent version in pom.xml
        run: |
          GROUP_ID=io.github.tmgg
          ARTIFACT_ID=tmgg-system-parent
          LATEST_VERSION=${{ steps.fetch-latest-version.outputs.latest_version }}

          echo "正在将 parent ${GROUP_ID}:${ARTIFACT_ID} 的版本更新为: $LATEST_VERSION"

          # 使用 xmlstarlet 直接修改 pom.xml 中的 <parent><version>
          xmlstarlet ed -L \
            -N x="http://maven.apache.org/POM/4.0.0" \
            -u "/x:project/x:parent/x:version" \
            -v "$LATEST_VERSION" pom.xml

          echo "✅ pom.xml 中的 parent 版本已更新."

      - name: Commit and Push updated pom.xml
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add pom.xml
          if git diff --quiet && git diff --staged --quiet; then
            echo "ℹ️  没有版本变更，无需提交。"
          else
            git commit -m "chore(deps): 自动更新 parent ${GROUP_ID}:${ARTIFACT_ID} 到最新版本 $LATEST_VERSION"
            git push
            echo "✅ 已提交并推送更新后的 pom.xml"
          fi
