name: Update tmgg-system-parent Version (from Maven Central metadata)

on:
  schedule:
    # 每天 UTC 08:00 执行，可自定
    - cron: '0 8 * * *'
  workflow_dispatch:  # 允许手动触发
  push:

jobs:
  update-parent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取全部历史，以便 push

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install xmlstarlet
        run: sudo apt-get update && sudo apt-get install -y xmlstarlet libxml2-utils

      - name: Fetch maven-metadata.xml for tmgg-system-parent
        id: fetch-metadata
        run: |
          GROUP_ID=io.github.tmgg
          ARTIFACT_ID=tmgg-system-parent

          GROUP_PATH=$(echo $GROUP_ID | tr '.' '/')
          METADATA_URL="https://repo.maven.apache.org/maven2/${GROUP_PATH}/${ARTIFACT_ID}/maven-metadata.xml"

          echo "Fetching metadata from: $METADATA_URL"
          curl -s -o maven-metadata.xml "$METADATA_URL"

          # 检查是否下载成功
          if [ ! -s maven-metadata.xml ]; then
            echo "❌ 无法下载 maven-metadata.xml，可能该构件不存在于此路径或网络错误。"
            echo "请确认："
            echo "  groupId = $GROUP_ID"
            echo "  artifactId = $ARTIFACT_ID"
            echo "  metadata URL = $METADATA_URL"
            exit 1
          fi

          # 提取最新版本：取 <latest>
          LATEST_VERSION=$(xmllint --xpath "string(//latest)" maven-metadata.xml)
       

          if [ -z "$LATEST_VERSION" ]; then
            echo "❌ 无法从 maven-metadata.xml 中解析出最新版本。"
            exit 1
          fi

          echo "✅ 解析到的最新版本是: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Update parent version in pom.xml
        run: |
          GROUP_ID=io.github.tmgg
          ARTIFACT_ID=tmgg-system-parent
          LATEST_VERSION=${{ steps.fetch-metadata.outputs.latest_version }}

          echo "正在将 parent ${GROUP_ID}:${ARTIFACT_ID} 的版本更新为: $LATEST_VERSION"

          # 使用 xmlstarlet 直接更新 <parent><version>
          xmlstarlet ed -L \
            -N x="http://maven.apache.org/POM/4.0.0" \
            -u "/x:project/x:parent/x:version" \
            -v "$LATEST_VERSION" pom.xml

          echo "✅ pom.xml 中的 parent 版本已更新为 $LATEST_VERSION"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add pom.xml
          if git diff --quiet && git diff --staged --quiet; then
            echo "ℹ️ 没有版本变更，无需提交。"
          else
            git commit -m "chore(deps): 自动更新 parent io.github.tmgg:tmgg-system-parent 到最新版本 ${{ steps.fetch-metadata.outputs.latest_version }}"
            git push
            echo "✅ 已提交并推送更新后的 pom.xml"
          fi
